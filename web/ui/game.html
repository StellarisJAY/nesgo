<!DocType html>
<head>
    <title>{{.game}}</title>
</head>
<html lang="cn">
    <div>
        <p>{{.id}}</p>
        <p id="boost">Boost: 1.0</p>
    </div>
    <div>
        <canvas id="{{.id}}" width="256" height="240"></canvas>
        <button onclick="incScale()">+</button>
        <button onclick="decScale()">-</button>
        <button onclick="decCPURate()"><<</button>
        <button onclick="incCPURate()">>></button>
    </div>
</html>

<script>
    const c = document.getElementsByTagName("canvas").item(0)
    const gameId = c.id
    const maxScale = 3
    const minScale = 1
    const width = 256
    const height = 240

    let gameConfigs = {
        boostRate: 1.0,
        scale: 3,
    }

    c.width = width * gameConfigs.scale
    c.height = height * gameConfigs.scale

    let ctx = c.getContext('2d')
    let ws = new WebSocket("ws://localhost:8080/ws/"+gameId)

    ws.onmessage = function (event) {
        // blob to frame
        let reader = new FileReader()
        reader.onloadend = function () {
            drawCompressedFrame(reader.result)
        }
        reader.readAsArrayBuffer(event.data)
    }

    onkeydown = function (event) {
        const code = event.code
        if (code === "KeyA" || code === "KeyD" || code === "KeyW" || code === "KeyS" ||
            code === "Space" || code === "Enter" || code === "KeyJ") {
            ws.send(JSON.stringify({"KeyCode": code, "Action": 0}))
        }
    }

    onkeyup = function (event) {
        const code = event.code
        if (code === "KeyA" || code === "KeyD" || code === "KeyW" || code === "KeyS" ||
            code === "Space" || code === "Enter" || code === "KeyJ") {
            ws.send(JSON.stringify({"KeyCode": code, "Action": 1}))
        }
    }

    function drawCompressedFrame(frameData) {
        const view = new DataView(frameData)
        let imageData = ctx.getImageData(0, 0, width * gameConfigs.scale, height * gameConfigs.scale)
        const frameSize = width * height
        for (let i = 0; i < frameSize; i++) {
            let colorId = view.getUint8(i)
            setScaledPixel(i, view.getUint8(frameSize + colorId*3),
                view.getUint8(frameSize + colorId*3 + 1),
                view.getUint8(frameSize + colorId*3 + 2),
            imageData)
        }
        ctx.putImageData(imageData, 0, 0)
    }

    function setScaledPixel(pixelNum, r,g,b, imageData) {
        let scale = gameConfigs.scale
        let row = Math.floor(pixelNum / width)
        let col = pixelNum % width
        let x0 = col * scale
        let y0 = row * scale
        for (let p = 0; p < scale; p++) {
            for (let q = 0; q < scale; q++){
                let index = xyToFrameIndex(x0+p,y0+q)
                let i = index * 4
                imageData.data[i] = r
                imageData.data[i+1] = g
                imageData.data[i+2] = b
                imageData.data[i+3] = 255
            }
        }
    }

    function xyToFrameIndex(x, y) {
        let w = width * gameConfigs.scale
        return x + y * w
    }

    function incScale() {
        gameConfigs.scale = Math.min(maxScale, gameConfigs.scale + 1)
        c.width = width * gameConfigs.scale
        c.height = height * gameConfigs.scale
    }

    function decScale() {
        gameConfigs.scale = Math.max(minScale, gameConfigs.scale - 1)
        c.width = width * gameConfigs.scale
        c.height = height * gameConfigs.scale
    }

    function incCPURate() {
        let oldRate = gameConfigs.boostRate
        gameConfigs.boostRate = Math.min(5.0, gameConfigs.boostRate + 0.5)
        if (oldRate !== gameConfigs.boostRate) {
            boostCPU(gameConfigs.boostRate)
        }

    }

    function decCPURate() {
        let oldRate = gameConfigs.boostRate
        gameConfigs.boostRate = Math.max(1.0, gameConfigs.boostRate - 0.5)
        if (oldRate !== gameConfigs.boostRate) {
            boostCPU(gameConfigs.boostRate)
        }
    }

    function boostCPU(rate) {
        fetch("http://localhost:8080/game/"+gameId+"/boost/"+rate, {method: "POST"})
            .then(data=>{
                return data.json()
            })
            .then(res=>{
                document.getElementById("boost").innerText = "Boost: " + gameConfigs.boostRate
            })
            .catch(error=>{

            })
    }
</script>